name: Monthly Data Sync & Parquet Generator

on:
  schedule:
    # 15th of every month at 6:00 PM IST (12:30 PM UTC)
    - cron: '30 12 15 * *'
  workflow_dispatch: # Manual trigger
    inputs:
      force_regenerate:
        description: 'Force parquet generation even if no upstream changes?'
        type: boolean
        default: false
        required: false

permissions:
  contents: write

jobs:
  sync-and-generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper sync
      
      - name: ğŸ” Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: ğŸ”„ Check upstream changes
        id: check_upstream
        run: |
          echo "ğŸ“¡ Fetching upstream repository..."
          git remote add upstream https://github.com/BennyThadikaran/eod2_data.git || true
          git fetch upstream main
          
          echo "ğŸ” Checking for changes..."
          BEHIND=$(git rev-list HEAD..upstream/main --count)
          
          if [ "$BEHIND" -gt 0 ]; then
            echo "âœ… Found $BEHIND new commits in upstream"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "commits_behind=$BEHIND" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ Already up to date with upstream"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "commits_behind=0" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ”„ Sync with upstream
        if: steps.check_upstream.outputs.has_changes == 'true'
        run: |
          echo "ğŸ”„ Syncing with upstream..."
          git merge upstream/main --no-edit -m "ğŸ”„ Synced with upstream on $(TZ='Asia/Kolkata' date +"%Y-%m-%d %I:%M:%S %p IST")"
          
          echo "ğŸ“¤ Pushing sync to origin..."
          git push origin main
          
          echo "âœ… Sync completed successfully!"
      
      - name: ğŸ›‘ Check if parquet generation needed
        id: should_generate
        run: |
          FORCE="${{ github.event.inputs.force_regenerate }}"
          HAS_CHANGES="${{ steps.check_upstream.outputs.has_changes }}"
          
          if [ "$FORCE" == "true" ]; then
            echo "ğŸ”„ Force regenerate enabled - will generate parquet"
            echo "generate=true" >> $GITHUB_OUTPUT
            echo "reason=forced" >> $GITHUB_OUTPUT
          elif [ "$HAS_CHANGES" == "true" ]; then
            echo "âœ… Upstream changes detected - will generate parquet"
            echo "generate=true" >> $GITHUB_OUTPUT
            echo "reason=upstream_changes" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ No changes detected and force not enabled - skipping parquet generation"
            echo "generate=false" >> $GITHUB_OUTPUT
            echo "reason=no_changes" >> $GITHUB_OUTPUT
          fi
      
      - name: âš™ï¸ Set up Python
        if: steps.should_generate.outputs.generate == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        if: steps.should_generate.outputs.generate == 'true'
        run: |
          echo "ğŸ“¦ Installing Python dependencies..."
          pip install -r requirements.txt
          echo "âœ… Dependencies installed"
      
      - name: ğŸ—‘ï¸ Delete old parquet file
        if: steps.should_generate.outputs.generate == 'true'
        run: |
          if [ -f "merged_data.parquet" ]; then
            echo "ğŸ—‘ï¸ Removing old parquet file..."
            rm -f merged_data.parquet
            echo "âœ… Old file removed"
          else
            echo "â„¹ï¸ No old parquet file found"
          fi
      
      - name: ğŸš€ Generate Parquet (with retry)
        if: steps.should_generate.outputs.generate == 'true'
        id: generate
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          command: python merge_to_parquet.py
      
      - name: ğŸ” Check for generated parquet file
        if: steps.should_generate.outputs.generate == 'true'
        id: check_file
        run: |
          if [ -f "merged_data.parquet" ]; then
            echo "âœ… Parquet file generated successfully"
            FILE_SIZE=$(du -h "merged_data.parquet" | cut -f1)
            echo "ğŸ“Š File size: $FILE_SIZE"
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
          else
            echo "âŒ Parquet file not found!"
            echo "file_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: âœ… Validate parquet file
        if: steps.check_file.outputs.file_exists == 'true'
        run: |
          echo "ğŸ” Validating parquet file..."
          python -c "
          import polars as pl
          import sys
          try:
              df = pl.read_parquet('merged_data.parquet')
              rows = len(df)
              cols = len(df.columns)
              print(f'âœ… Validation passed: {rows:,} rows, {cols} columns')
              print(f'ğŸ“‹ Columns: {df.columns}')
              print(f'ğŸ“… Date range: {df[\"Date\"].min()} to {df[\"Date\"].max()}')
              print(f'ğŸ¢ Unique symbols: {df[\"SYMBOL\"].n_unique()}')
              
              if rows == 0:
                  print('âŒ Error: Parquet file is empty!')
                  sys.exit(1)
              
              # Show first 5 rows preview
              print('\nğŸ“Š Data Preview (first 5 rows):')
              print(df.head(5))
              
          except Exception as e:
              print(f'âŒ Validation failed: {e}')
              sys.exit(1)
          "
      
      - name: ğŸ’¾ Commit and push parquet file
        if: steps.check_file.outputs.file_exists == 'true'
        id: commit
        run: |
          echo "â• Staging parquet file..."
          git add merged_data.parquet
          
          DATE_IST=$(TZ='Asia/Kolkata' date +"%Y-%m-%d %I:%M:%S %p IST")
          FILE_SIZE="${{ steps.check_file.outputs.file_size }}"
          COMMITS="${{ steps.check_upstream.outputs.commits_behind }}"
          REASON="${{ steps.should_generate.outputs.reason }}"
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No changes in parquet file content"
            git commit --allow-empty -m "âœ… NSE merged data refreshed on ${DATE_IST}" \
              -m "ğŸ“Š File size: ${FILE_SIZE}" \
              -m "ğŸ“ Reason: ${REASON}" \
              -m "ğŸ”„ Upstream commits synced: ${COMMITS}" \
              -m "ğŸ¤– Automated monthly update via GitHub Actions"
            echo "commit_type=refresh" >> $GITHUB_OUTPUT
          else
            echo "ğŸ’¾ New data detected - creating commit..."
            git commit -m "âœ… NSE merged data updated on ${DATE_IST}" \
              -m "ğŸ“Š File size: ${FILE_SIZE}" \
              -m "ğŸ“ Reason: ${REASON}" \
              -m "ğŸ”„ Upstream commits synced: ${COMMITS}" \
              -m "ğŸ¤– Automated monthly update via GitHub Actions"
            echo "commit_type=new" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸš€ Pushing to remote..."
          git push origin main
          
          echo "âœ¨ Parquet file successfully committed and pushed!"
      
      - name: ğŸ“Š Generate workflow summary
        if: always()
        run: |
          echo "## ğŸ“ˆ Monthly Sync & Parquet Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Upstream status
          echo "### ğŸ”„ Upstream Sync" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_upstream.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **Synced**: ${{ steps.check_upstream.outputs.commits_behind }} new commits merged" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Status**: Already up to date" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parquet generation status
          echo "### ğŸ“¦ Parquet Generation" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.should_generate.outputs.generate }}" == "true" ]; then
            if [ "${{ steps.check_file.outputs.file_exists }}" == "true" ]; then
              echo "âœ… **Status**: Success" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ“ **File**: \`merged_data.parquet\`" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ“Š **Size**: ${{ steps.check_file.outputs.file_size }}" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ“ **Reason**: ${{ steps.should_generate.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
              
              if [ "${{ steps.commit.outputs.commit_type }}" == "new" ]; then
                echo "ğŸ’¾ **Commit**: New data pushed" >> $GITHUB_STEP_SUMMARY
              elif [ "${{ steps.commit.outputs.commit_type }}" == "refresh" ]; then
                echo "ğŸ”„ **Commit**: Refreshed (no content change)" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âŒ **Status**: Failed - File generation error" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **Status**: Skipped" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“ **Reason**: ${{ steps.should_generate.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Timestamp
          DATE_IST=$(TZ='Asia/Kolkata' date +"%Y-%m-%d %I:%M:%S %p IST")
          echo "ğŸ•’ **Completed**: ${DATE_IST}" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up..."
          git remote remove upstream 2>/dev/null || true
          echo "âœ… Cleanup completed"
      
      - name: ğŸ”” Notify on failure
        if: failure()
        run: |
          echo "::error::âŒ Monthly sync & parquet generation workflow failed!"
          echo "::error::Check logs above for details"
          exit 1
